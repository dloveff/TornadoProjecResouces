#! /usr/bin/env python
# -*- coding: utf-8 -*-

__author__ = '北极鱼'

import tornado.web, meta, auth,  random
import xml.etree.ElementTree as ET
from db import Mysqldb, log

# 创建圈子
class CreateCircleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/createcircle'
    def post(self):

        dao = CircleDao()
        root = ET.fromstring(self.request.body)
        name = root.find('name').text
        mname = root.find('mname').text
        res = dao.create_circle(name,mname ,self.get_secure_cookie('mobile'))
        if res is not None:
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write('<member id="%s"/>'% int(res))
        else:
            self.send_error(401)
# 添加角色
class AddRoleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route =r'/mod/cms/addrole'
    def post(self):

        dao = CircleDao()
        root = ET.fromstring(self.request.body)
        rolename = root.find('rolename').text
        res = dao.create_role(self.get_secure_cookie('mobile'),rolename)
        if res is not None:
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write('<roles id="%s"/>'% int(res))
        else:
            self.send_error(401)

# 添加圈子
class AddCircleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/addcircle'
    def post(self):

        dao = CircleDao()
        root = ET.fromstring(self.request.body)
        circle = root.find('circle').text                           # 要添加的圈子
        circlename = root.find('circlename').text                   # 在圈子内的昵称
        res = dao.add_circle(circle, self.get_secure_cookie('mobile'), circlename)
        if res is not None:
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write('<circles id="%s"/>'% int(res))
        else:
            self.send_error(401)

# 为成员分配角色
class PutMemberRoleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/putmemberrole/(.*)'
    def put(self,memberid):
        dao = CircleDao()
        root = ET.fromstring(self.request.body)
        rolename = root.find('role').text
        dao.update_member_role(self.get_secure_cookie('mobile'), memberid, rolename)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<roles id="'+memberid+'"/>')

# 修改角色
class PutRoleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/putrole/(.*)'
    def put(self,roleid):
        dao = CircleDao()
        root = ET.fromstring(self.request.body)
        rolename = root.find('role').text
        res = dao.update_role(self.get_secure_cookie('mobile'), rolename, roleid)
        if res is not None:
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write('<roles id="'+res+'"/>')
        else:
            self.send_error(401)


# 删除角色
class RemoveRoleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/removerole/(.*)'
    def delete(self, roleid):
        dao = CircleDao()
        dao.reomeve_role(self.get_secure_cookie('mobile'),roleid)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<roles id="'+roleid+'"/>')
# 退出圈子
class ExitCircleHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/mod/cms/exitcircle/(.*)'
    def delete(self,memberid):
        dao = CircleDao()
        dao.exit_circle(memberid)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<circles id="'+memberid+'"/>')

# 踢出成员
class ExitMemberHandler(tornado.web.RequestHandler):
    __metaclass__=meta.HandlerMetaClass
    route =r'/mod/cms/exitmember/(.*)'
    def delete(self, memberid):
        dao = CircleDao()
        dao.exit_member(self.get_secure_cookie('mobile'),memberid)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<members id="'+memberid+'"/>')


class CircleMemberListHandler(tornado.web.RequestHandler):
    __metaclass__= meta.HandlerMetaClass
    route =r'/mod/cms/memberlist'
    def get(self):
        dao = CircleDao()
        root = ET.Element('member_list')   #设置根节点
        for res in dao.query_circles_list(self.get_secure_cookie('mobile')) or []:
            id,name,roleid,circleid,memberid = res
            mess = ET.SubElement(root,'members', {'id':str(id)}) #设置子节点 属性值
            self.__append_element(mess, 'name', name)
            self.__append_element(mess, 'roleid', roleid)
            self.__append_element(mess, 'circleid', circleid)
            self.__append_element(mess, 'memberid', memberid)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write(ET.tostring(root, encoding='UTF-8'))

    def __append_element(self, parent, tag, value):
        e = ET.Element(tag)
        if value:
            e.text = value
        parent.append(e)

#   检索角色列表
class RoleListHandler(tornado.web.RequestHandler):
    __metaclass__= meta.HandlerMetaClass
    route =r'/mod/cms/rolelist'
    def get(self):
        dao = CircleDao()
        root = ET.Element('role_list')   #设置根节点
        for res in dao.query_role_list(self.get_secure_cookie('mobile')) or []:
            id , name , circleid = res
            mess = ET.SubElement(root,'roles', {'id':str(id)}) #设置子节点 属性值
            self.__append_element(mess, 'name', name)
            self.__append_element(mess, 'circleid', circleid)
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write(ET.tostring(root, encoding='UTF-8'))

    def __append_element(self, parent, tag, value):
        e = ET.Element(tag)
        if value:
            e.text = value
        parent.append(e)
class CircleDao(object):
    def __init__(self):
        self.db = Mysqldb()
        self.__create_table(self.db)

    def __create_table(self, db):
        #  圈子
        db.execute('''
                CREATE TABLE IF NOT EXISTS weicbd_mp_circle(
                id bigint NOT NULL AUTO_INCREMENT,
                name varchar(50) NOT NULL,
                PRIMARY KEY (id)
                ) ''')

        # 角色
        db.execute('''
                CREATE TABLE IF NOT EXISTS weicbd_mp_role(
                id bigint NOT NULL AUTO_INCREMENT,
                name varchar(30) NOT NULL,
                circleid bigint NULL,
                FOREIGN KEY (circleid) REFERENCES weicbd_mp_circle(id),
                PRIMARY KEY (id)
                )
         ''')

        #  圈子成员
        db.execute('''
                CREATE TABLE IF NOT EXISTS weicbd_mp_circle_member(
                id bigint NOT NULL AUTO_INCREMENT,
                name varchar(50) NOT NULL,
                roleid  bigint NULL,
                circleid bigint NULL,
                memberid bigint NULL,
                FOREIGN KEY (circleid) REFERENCES weicbd_mp_circle(id),
                FOREIGN KEY (roleid) REFERENCES weicbd_mp_role(id),
                FOREIGN KEY (memberid) REFERENCES weicbd_mp_member(id),
                PRIMARY KEY (id)
                )
         ''')
        db.commit()

    # 创建圈子
    def create_circle(self, name, mname, member):
        # 找到当前帐号的id
        memberid, = self.db.fetchone('select id from weicbd_mp_member where mobile=%s',(member,)) or (None, )
        if memberid is not None:
            # 新建圈子成功返回圈子ID
            circleid = self.db.execute('insert into weicbd_mp_circle (name) values(%s)', (name,)) or (None, )
            # 新建一个圈主的角色
            roleid = self.db.execute('insert into weicbd_mp_role (name,circleid) values("圈主",%s)',(circleid, )) or (None, )
            # 新建一个成员变量
            self.db.execute('insert into weicbd_mp_circle_member (name, roleid, circleid, memberid) values(%s, %s, %s, %s)', (mname, roleid, circleid, memberid)) or (None,)
            self.db.commit()
            return circleid

    # 添加圈子 参数 圈子名称 当前账户，圈子成员名称
    def add_circle(self,circle,member,circlename):
        # 找到要添加的圈子ID
        circleid, = self.db.fetchone('select id from weicbd_mp_circle where name=%s',(circle,)) or (None, )
        # 找到当前帐号的ID
        memberid, = self.db.fetchone('select id from weicbd_mp_member where mobile=%s',(member,)) or (None, )
        if (circleid is not None) and (memberid is not None):
            res = self.db.execute('insert into weicbd_mp_circle_member (name,circleid,memberid) values(%s,%s,%s) ',(circlename,circleid,memberid))
            self.db.commit()
            return res

    # 退出圈子
    def exit_circle(self, memberid):
        self.db.execute('delete from weicbd_mp_circle_member where id=%s', (memberid,)) or (None, )
        self.db.commit()

    # 踢出成员
    def exit_member(self, mobile, memberid):
        role, = self.db.fetchone('SELECT a.name FROM weicbd_mp_role a, weicbd_mp_circle_member b, weicbd_mp_member c WHERE a.id = b.roleid AND b.memberid = c.id AND c.mobile = %s', (mobile,)) or (None, )
        if role == '圈主':
            self.db.execute('delete from weicbd_mp_circle_member where id=%s', (memberid,))
            self.db.commit()
    # 创建角色
    def create_role(self, circlemember, rname):
        circleid, = self.db.fetchone('select a.circleid from weicbd_mp_circle_member a ,weicbd_mp_member b where a.memberid = b.id and b.mobile = %s',(circlemember,)) or (None, )
        if circleid is not None:
            rid = self.db.execute('insert into weicbd_mp_role (name,circleid) values(%s,%s)',(rname,circleid)) or (None, )
            self.db.commit()
            return rid

    # 修改角色列表
    def update_role(self, mobile, name, roleid):
        # 找到当前用户是否为圈主
        role, = self.db.fetchone('SELECT a.name FROM weicbd_mp_role a, weicbd_mp_circle_member b, weicbd_mp_member c WHERE a.id = b.roleid AND b.memberid = c.id AND c.mobile = %s', (mobile,)) or (None, )
        if role == '圈主':
            self.db.execute('update weicbd_mp_role set name=%s where id = %s ', (name, roleid))
            self.db.commit()
            return roleid

    # 修改成员角色
    def update_member_role(self,mobile,memberid,rolename):
        # 找到当前用户是否为圈主
        role, = self.db.fetchone('SELECT a.name FROM weicbd_mp_role a, weicbd_mp_circle_member b, weicbd_mp_member c WHERE a.id = b.roleid AND b.memberid = c.id AND c.mobile = %s',(mobile,)) or (None, )
        roleid, = self.db.fetchone('select id from weicbd_mp_role where name=%s',(rolename,)) or (None, )
        if (role == '圈主') and (roleid is not None):
            self.db.execute('update weicbd_mp_circle_member set roleid=%s where id=%s',(roleid,memberid))
            self.db.commit()

    # 删除角色
    def reomeve_role(self,mobile,roleid):
        # 找到当前用户是否为圈主
        role, = self.db.fetchone('SELECT a.name FROM weicbd_mp_role a, weicbd_mp_circle_member b, weicbd_mp_member c WHERE a.id = b.roleid AND b.memberid = c.id AND c.mobile = %s',(mobile,)) or (None, )
        if role == '圈主':
            self.db.execute('delete from weicbd_mp_role where id = %s',(roleid, )) or []
            self.db.commit()
    # 圈子成员列表
    def query_circles_list(self,mobile):
        circleid, = self.db.fetchone('select a.circleid from weicbd_mp_circle_member a ,weicbd_mp_member b where a.memberid = b.id and b.mobile = %s',(mobile,)) or (None, )
        if circleid is not None:
            return self.db.fetchall('select id,name,roleid,circleid,memberid from weicbd_mp_circle_member') or (None, )

    # 角色列表
    def query_role_list(self, mobile):
        # 找到当前用户是否为圈主
        role, = self.db.fetchone('SELECT a.name FROM weicbd_mp_role a, weicbd_mp_circle_member b, weicbd_mp_member c WHERE a.id = b.roleid AND b.memberid = c.id AND c.mobile = %s',(mobile,)) or (None, )
        circleid, = self.db.fetchone('select a.circleid from weicbd_mp_circle_member a ,weicbd_mp_member b where a.memberid = b.id and b.mobile = %s',(mobile,)) or (None, )
        if (role == '圈主') and (circleid is not None):
            return self.db.fetchall('select id,name,circleid from weicbd_mp_role where circleid=%s',(circleid))






























































