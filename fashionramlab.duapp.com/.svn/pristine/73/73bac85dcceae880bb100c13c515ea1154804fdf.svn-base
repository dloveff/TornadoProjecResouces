#! /usr/bin/env python
# -*- coding: utf-8 -*-
import tornado.wsgi, os, meta
import weicbd.aaa, weicbd.mp, weicbd.recvpattern, weicbd.messagepattern, weicbd.mpmember , weicbd.cmsarticle, weicbd.register, weicbd.cmscircle, weicbd.weicbd_account_images
import wx, weicbd.mpconsole, plugin.common, plugin.WallPlugins, plugin.TestStatus


class MainHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/handlers'
    def get(self):
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<handlers>')
        for u in self.application.handlers[0][1]:
            self.write('<handle><route>%s</route><class>%s</class></handle>' % (u.regex.pattern, u.handler_class.__name__))
        self.write('</handlers>')
 
 
class LogHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/log'
    def get(self):
        self.write('<html><body>')
        from db import Mysqldb
        mdb = Mysqldb()
        for r in mdb.fetchall('SELECT createTime, content FROM weicbd_log ORDER BY createTime desc LIMIT 0, 10'):
            self.write('<p>%s</p><p><xmp>%s</xmp></p><hr/>' % (r[0], r[1]))
        self.write('</body></html>')

class PluginListHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/replyplugin'
    def get(self):
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<plugins>')
        for k, v in meta.PluginMetaClass.plugins.items():
            self.write('<plugin><name>%s</name><class>%s</class></plugin>' % (v.name, k))
        self.write('</plugins>')

class CrossDomainHandler(tornado.web.RequestHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/cross'

    def post(self):
        from db import log
        import xml.etree.ElementTree as ET
        import urllib2
        try:

            root = ET.fromstring(self.request.body)
            opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())
            request = urllib2.Request(root.find('url').text)
            if root.find('method').text.upper() == 'GET':
                response = opener.open(request)
            elif root.find('method').text.upper() == 'POST':
                response = opener.open(request, root.find('data').text.encode('utf-8'))

            responseData = response.read()

            self.write(responseData)
        except:
            import traceback
            log(traceback.format_exc())


app_root = os.path.dirname(__file__)
settings = { 
    'static_path' : os.path.join(app_root, 'static'),
    'template_path' : os.path.join(app_root, 'templates'),
    'gzip' : True,
    'debug' : True,
    'cookie_secret': '__FASHION_RAM_LAB_DUAPP_COM__',
}

handlers = meta.HandlerMetaClass.handlers + [
    (r'/(.*\.html)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
    (r'/(.*\.htm)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
    (r'/(.*\.css)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
    (r'/(.*\.js)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
    (r'/(.*\.png)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
    (r'/(.*\.jpg)', tornado.web.StaticFileHandler, {'path': settings['static_path']}),
]
app = tornado.wsgi.WSGIApplication(handlers, **settings)

from bae.core.wsgi import WSGIApplication
application = WSGIApplication(app)
