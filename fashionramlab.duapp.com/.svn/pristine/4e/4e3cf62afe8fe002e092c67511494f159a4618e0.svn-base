#! /usr/bin/env python
# -*- coding: utf-8 -*-

import tornado.web, json
import meta
from model.aaa import Passport
from orm import getSession
import xml.etree.ElementTree as ET


class AuthBaseHandler(tornado.web.RequestHandler):
    def get_current_user(self):
        pp = self.get_secure_cookie('passport')
        return json.loads(pp) if pp else None
    

class AuthLoginHandler(AuthBaseHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/login'
        
    def get(self):
        try:
            prompt = self.get_argument('prompt')
        except:
            prompt = ''
        self.render('login.html', prompt=prompt)        

    def post(self):
        session = getSession()
        email = self.get_argument('email', '')
        password = self.get_argument('password', '')        
        pp = session.query(Passport).filter(Passport.email == email, Passport.password == password).first()
        
        if pp:
            self.set_secure_cookie('passport', json.dumps(dict(id=pp.id, email=pp.email, mobile=pp.mobile)))
            self.redirect(self.get_argument('next', u'/'))
        else:
            prompt_msg = u'?prompt=' + tornado.escape.url_escape('用户名或密码错误')
            self.redirect(u"/login" + prompt_msg)            
        session.close()


class AuthLogoutHandler(AuthBaseHandler):
    def get(self):
        self.clear_cookie('user')
        self.redirect(self.get_argument('next', '/'))


class PassportHandler(AuthBaseHandler):
    __metaclass__ = meta.HandlerMetaClass
    route = r'/passport'

    def get(self):
        pp = self.get_current_user()
        
        if pp:
            root = ET.Element('passport', id=str(pp.get('id')))
            ET.SubElement(root, 'email').text = pp.get('email')
            ET.SubElement(root, 'mobile').text = pp.get('mobile')
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write(ET.tostring(root, encoding='UTF-8'))
        else:
            self.send_error(401)
            
    def post(self):
        root = ET.fromstring(self.request.body)
        
        session = getSession()
        
        pp = Passport(
            root.findtext('email'),
            root.findtext('mobile'),
            root.findtext('password')
        )
        session.add(pp)
        session.commit()
        
        self.set_secure_cookie('passport', json.dumps(dict(id=pp.id, email=pp.email, mobile=pp.mobile)))
        
        self.set_header('Content-Type', 'text/xml; charset=utf-8')
        self.write('<passport id ="%d"/>' % pp.id)
        
    def put(self):
        root = ET.fromstring(self.request.body)
        email = root.findtext('email')
        mobile = root.findtext('mobile')
        
        from sqlalchemy import or_
        
        session = getSession()
        pp = session.query(Passport).filter(or_(Passport.email == email, Passport.mobile == mobile)).first()
        cpp = self.get_current_user()
        if pp and (pp.id == cpp['id']):
            pp.email = email
            pp.mobile = mobile
            pp.password = root.findtext('password')
            
            session.merge(pp)
            session.commit()
            
            self.set_header('Content-Type', 'text/xml; charset=utf-8')
            self.write('<passport id ="%d"/>' % pp.id)
        else:
            self.send_error(403)

